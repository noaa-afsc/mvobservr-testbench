---
title: "building iterations"
output: html_notebook
---

The goal is to set up a simple looping function to take in data, pass it through the mvobs package, and then return the most important results in a dataframe. 


decided to use 100 permutations based on the results in min_replicable.Rmd. 
also going to start with 3 species for building, can be expanded later.

```{r setup}
library(tidyverse)
library(FMAtools)  
library(mvobservr)
source("functions/mvglm_obs_dd.R")
```

```{r dataprep}
#results in a list split by stratum
load("source_data/1_mvglm_obs_data_segmented.Rdata") #original data

ob.fx.b <- merge(sums_l, spp_exp_segmented %>% filter(segment_new == "Keep") %>%
                       select(STRATA, Species) %>% distinct()) %>%
  filter(STRATA == "OB FIXED BSAI") %>%
  select(species = Species, uid = TRIP_ID, days.fished, observed = OBSERVED_FLAG, biomass = Biomass, BLOCK, days.fished)

spp_top_n <- ob.fx.b %>%
  group_by(species) %>%
  summarize(b=sum(biomass)) %>%
  arrange(desc(b)) %>%
  slice_max(n=3, order_by=b)

#extract a single stratum and reduce the number of species
xdat <- ob.fx.b %>%
  filter(species %in% spp_top_n$species)  

```



pivot data to wide format to select trips, set all to unobserved
```{r}
pdat <- xdat %>%
  pivot_wider(names_from = species, values_from = biomass) %>%
  mutate(observed = 'N') 
```



#test 1 - resampling observed trips randomly

create a function for looping
```{r}
loop_mvglm <- function(dat, covrate, nperm, bias=NA){
  idat <- dat %>% 
    mutate(observed = ifelse(runif(nrow(.)) <= covrate, 'Y', 'N')) %>% 
        pivot_longer(cols=-c(uid, days.fished, observed, BLOCK),
                 names_to = 'species', values_to = 'biomass') 
  
  if(!is.na(bias)) {
    #add bias to all species equally for observed trips only
    idat <- idat %>% 
        mutate(biomass =  biomass * ifelse(observed == 'Y',(1+bias), 1))
  }
  
  
  idat %>%
    mvglm_obs_dd(n_permutations=nperm) %>%
    as.data.frame() #get p and uni.p's on one row per iteration
}
```


set up simple loop and capture output from each rep
```{r, warning=FALSE, message=FALSE}
nperm = 100 #about 1 minute for 100 permutations for 3 species
covrate = 0.25
nrep = 100

system.time(res <- map(1:nrep, ~loop_mvglm(pdat, covrate, nperm)))

res_df <- list_rbind(res) 

save(res_df, file="output_data/obbsai3spp100rep100permcov25_20250813.Rdat")
```



```{r}
load("output_data/obbsai3spp100rep100permcov25_20250813.Rdat")
res_df %>%
  mutate(idx = 1:nrow(.)) %>%
  pivot_longer(cols=-idx) %>%
  ggplot(aes(x=name, y=value, col=name)) +
  geom_jitter() +
  geom_hline(yintercept = 0.05, linetype='dashed') +
  theme_bw() +
  guides(col="none") +
  labs(title = "distribution of results from 100 iterations of randomly selected trips",
       subtitle="lot of variation between iterations, as expected")

res_df %>%
  mutate(idx = 1:nrow(.)) %>%
  pivot_longer(cols=-idx) %>%
  group_by(name) %>%
  summarize(mean(value < 0.05))
```
include species sum expanded from gtable
  prevalence matters
  small changes to common species vs. large changes to rare species
  high, medium, and low species?

species sum extrapolated - what is their contribution to the stratum? 
  % occurrence
  % of total biomass in the stratum



```{r, warning=FALSE, message=FALSE, eval=FALSE}
nperm = 100 #about 1 minute for 100 permutations for 3 species
nrep = 100
covrates = seq(0.05, 0.95, by=0.1)

res_cov <- map(rep(covrates, each=nrep), ~{
    loop_mvglm(pdat, .x, nperm) %>%
    mutate(covrate = .x)
  })

res_cov_df <- list_rbind(res_cov) 

save(res_cov_df, file="output_data/obbsai3spp100rep100permcovramp_20250813.Rdat")
```



```{r}
load("output_data/obbsai3spp100rep100permcovramp_20250813.Rdat")
res_cov_df %>%
  mutate(idx = 1:nrow(.)) %>%
  pivot_longer(cols=-c(idx, covrate)) %>%
  group_by(name, covrate) %>%
  summarize(falsepos = mean(value < 0.05), .groups="drop") %>%
  ggplot(aes(x=covrate, y=falsepos, col=name)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0.05, linetype='dashed') +
  theme_bw() +
  labs(title = 'OB FIXED BSAI', subtitle = '100 iterations, random trip sampling',
       x='coverage rate', y='false positive rate (p < 0.05)')


nreps = 200
res_cov_df %>%
  mutate(idx = 1:nrow(.)) %>%
  pivot_longer(cols=-c(idx, covrate)) %>%
  group_by(name) %>%
  slice_sample(n = 100*nreps, replace=TRUE) %>%
  mutate(repnum = rep(1:nreps, each=100)) %>%
  group_by(repnum, name, covrate) %>%
  summarize(falsepos = mean(value < 0.05), .groups="drop") %>%
  ggplot(aes(x=covrate, y=falsepos)) +
  facet_wrap(~name) +
  #geom_point(alpha = 0.02) +
  geom_boxplot(aes(group=covrate)) +
  #geom_smooth() +
  theme_bw() +
  labs(title = 'OB FIXED BSAI',
       subtitle = '100 iterations of random trip sampling, 200 bootstrap repeats',
       x='coverage rate', y='false positive rate (p < 0.05)'
       ) +
  geom_hline(yintercept = 0.05, linetype='dashed')
```


#biased samples
##power to detect 20% reduction on oberved trips, by coverage rate
```{r, warning=FALSE, message=FALSE, eval=FALSE}
nperm = 100 #about 1 minute for 100 permutations for 3 species
nrep = 50
covrates = seq(0.05, 0.95, by=0.1)
length(covrates)*nrep*nperm/100/60 #estimated run hours at 1 min/100 perm
biasrate = -0.2

res_cov_b20 <- map(rep(covrates, each=nrep), ~{
    loop_mvglm(pdat, .x, nperm, biasrate) %>%
    mutate(covrate = .x)
  })

res_cov_b20_df <- list_rbind(res_cov_b20) 

res_cov_b20_df <- res_cov_b20_df %>%
  filter(row_number() <= 500)
save(res_cov_b20_df, file="output_data/obbsai3spp100rep100permcovramp_b20_20250820.Rdat")

res_cov_b20_df %>%
  count(covrate)
```

```{r}
load("output_data/obbsai3spp100rep100permcovramp_b20_20250820.Rdat")

res_cov_b20_df %>%
  mutate(idx = 1:nrow(.)) %>%
  pivot_longer(cols=-c(idx, covrate)) %>%
  group_by(name, covrate) %>%
  summarize(truepos = mean(value < 0.05), .groups="drop") %>%
  ggplot(aes(x=covrate, y=truepos, col=name)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0.05, linetype='dashed') +
  theme_bw() +
  labs(title = 'OB FIXED BSAI', subtitle = '100 iterations, random trip sampling, -20% bias',
       x='coverage rate', y='true positive rate (p < 0.05)')


nreps = 200
res_cov_b20_df %>%
  mutate(idx = 1:nrow(.)) %>%
  pivot_longer(cols=-c(idx, covrate)) %>%
  group_by(name) %>%
  mutate(name = factor(name,
                       levels=c("p","uni.p.Pacific.Cod","uni.p.Pacific.Halibut","uni.p.Sablefish..blackcod."),
                       labels=c("overall p-value", "Pac. Cod (freq 63%, biom 81%)",
                                "Pac. Hal. (freq 26%, biom 5%)", "Sablefish (freq 31%, biom 13%)"))) %>%
  slice_sample(n = 100*nreps, replace=TRUE) %>%
  mutate(repnum = rep(1:nreps, each=100)) %>%
  group_by(repnum, name, covrate) %>%
  summarize(truepos = mean(value < 0.05), .groups="drop") %>%
  ggplot(aes(x=covrate, y=truepos)) +
  facet_wrap(~name, scales="free") +
  #geom_point(alpha = 0.02) +
  geom_boxplot(aes(group=covrate)) +
  #geom_smooth() +
  theme_bw() +
  labs(title = 'OB FIXED BSAI',
       subtitle = '100 iterations of random trip sampling, -20% bias, 200 bootstrap repeats',
       x='coverage rate', y='true positive rate (p < 0.05)'
       ) +
  geom_hline(yintercept = 0.05, linetype='dashed') +
  stat_summary(fun=mean, geom="line")
```

Real expected biases for OB FIXED BSAI
Spp     Freq    Biom(%) Bias %
P Cod   63.1    80.6      3.1
Sable   30.9    13.4     12.5
P Hal   26.2     5.4    -39.7
Oct     19.4     0.5     99.2
Arr Fl   3.1    <0.1    -88.5
Atk Mk   3.1    <0.1    -63.9
Oth Scu 19.1    <0.1    -12.4
P Perc   5.3    <0.1     90.5
Poll    12.2    <0.1     47.6
Rgh Rk   5.6    <0.1    196.7
Sh Rck   2.2    <0.1    600.2
Th Rck   5.6    <0.1    249.6
YE Rck   2.8    <0.1     81.4
YF Sol   4.4    <0.1    -48.0






