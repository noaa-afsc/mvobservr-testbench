---
title: "building iterations"
output: html_notebook
---

The goal is to set up a simple looping function to take in data, pass it through the mvobs package, and then return the most important results in a dataframe. 


decided to use 100 permutations based on the results in min_replicable.Rmd. 
also going to start with 3 species for building, can be expanded later.

```{r setup}
library(tidyverse)
library(FMAtools)  
library(mvobservr)
source("functions/mvglm_obs_dd.R")
source("functions/loop_mvglm.R")
```

```{r dataprep}
#results in a list split by stratum
load("source_data/1_mvglm_obs_data_segmented.Rdata") #original data

ob.fx.b <- merge(sums_l, spp_exp_segmented %>% filter(segment_new == "Keep") %>%
                       select(STRATA, Species) %>% distinct()) %>%
  filter(STRATA == "OB FIXED BSAI") %>%
  select(species = Species, uid = TRIP_ID, days.fished, observed = OBSERVED_FLAG, biomass = Biomass, BLOCK, days.fished)

spp_top_n <- ob.fx.b %>%
  group_by(species) %>%
  summarize(b=sum(biomass)) %>%
  arrange(desc(b)) %>%
  slice_max(n=2, order_by=b)

#extract a single stratum and reduce the number of species
xdat <- ob.fx.b %>%
  filter(species %in% spp_top_n$species)  

```



pivot data to wide format to select trips, set all to unobserved
```{r}
pdat <- xdat %>%
  pivot_wider(names_from = species, values_from = biomass) %>%
  mutate(observed = 'N') 
```



#test 1 - resampling observed trips randomly

create a function for looping
(moved to loop_mvglm.R)

set up simple loop and capture output from each rep
```{r, warning=FALSE, message=FALSE}
nperm = 100 #about 1 minute for 100 permutations for 3 species
covrate = 0.25
nrep = 100

system.time(res <- map(1:nrep, ~loop_mvglm(pdat, covrate, nperm)))

res_df <- list_rbind(res) 

save(res_df, file="output_data/obbsai3spp100rep100permcov25_20250813.Rdat")
```



```{r}
load("output_data/obbsai3spp100rep100permcov25_20250813.Rdat")
res_df %>%
  mutate(idx = 1:nrow(.)) %>%
  pivot_longer(cols=-idx) %>%
  ggplot(aes(x=name, y=value, col=name)) +
  geom_jitter() +
  geom_hline(yintercept = 0.05, linetype='dashed') +
  theme_bw() +
  guides(col="none") +
  labs(title = "distribution of results from 100 iterations of randomly selected trips",
       subtitle="lot of variation between iterations, as expected")

res_df %>%
  mutate(idx = 1:nrow(.)) %>%
  pivot_longer(cols=-idx) %>%
  group_by(name) %>%
  summarize(mean(value < 0.05))
```
include species sum expanded from gtable
  prevalence matters
  small changes to common species vs. large changes to rare species
  high, medium, and low species?

species sum extrapolated - what is their contribution to the stratum? 
  % occurrence
  % of total biomass in the stratum



```{r, warning=FALSE, message=FALSE, eval=FALSE}
nperm = 100 #about 1 minute for 100 permutations for 3 species
nrep = 100
covrates = seq(0.05, 0.95, by=0.1)

res_cov <- map(rep(covrates, each=nrep), ~{
    loop_mvglm(pdat, .x, nperm) %>%
    mutate(covrate = .x)
  })

res_cov_df <- list_rbind(res_cov) 

save(res_cov_df, file="output_data/obbsai3spp100rep100permcovramp_20250813.Rdat")
```



```{r}
load("output_data/obbsai3spp100rep100permcovramp_20250813.Rdat")
res_cov_df %>%
  mutate(idx = 1:nrow(.)) %>%
  pivot_longer(cols=-c(idx, covrate)) %>%
  group_by(name, covrate) %>%
  summarize(falsepos = mean(value < 0.05), .groups="drop") %>%
  ggplot(aes(x=covrate, y=falsepos, col=name)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0.05, linetype='dashed') +
  theme_bw() +
  labs(title = 'OB FIXED BSAI', subtitle = '100 iterations, random trip sampling',
       x='coverage rate', y='false positive rate (p < 0.05)')


nreps = 200
res_cov_df %>%
  mutate(idx = 1:nrow(.)) %>%
  pivot_longer(cols=-c(idx, covrate)) %>%
  group_by(name) %>%
  slice_sample(n = 100*nreps, replace=TRUE) %>%
  mutate(repnum = rep(1:nreps, each=100)) %>%
  group_by(repnum, name, covrate) %>%
  summarize(falsepos = mean(value < 0.05), .groups="drop") %>%
  ggplot(aes(x=covrate, y=falsepos)) +
  facet_wrap(~name) +
  #geom_point(alpha = 0.02) +
  geom_boxplot(aes(group=covrate)) +
  #geom_smooth() +
  theme_bw() +
  labs(title = 'OB FIXED BSAI',
       subtitle = '100 iterations of random trip sampling, 200 bootstrap repeats',
       x='coverage rate', y='false positive rate (p < 0.05)'
       ) +
  geom_hline(yintercept = 0.05, linetype='dashed')
```


#biased samples
##power to detect 20% reduction on oberved trips, by coverage rate
```{r, warning=FALSE, message=FALSE, eval=FALSE}
nperm = 100 #about 1 minute for 100 permutations for 3 species
nrep = 100
covrates = seq(0.05, 0.95, by=0.1)
length(covrates)*nrep*nperm/100/60 #estimated run hours at 1 min/100 perm
biasrate = -0.3

res_cov_b30 <- map(rep(covrates, each=nrep), ~{
    loop_mvglm(pdat, .x, nperm, biasrate) %>%
    mutate(covrate = .x)
  })

res_cov_b30_df <- list_rbind(res_cov_b30) 

save(res_cov_b30_df, file="output_data/obbsai3spp100rep100permcovramp_b30_20250820.Rdat")

res_cov_b30_df %>%
  count(covrate)
```

```{r}
load("output_data/obbsai3spp100rep100permcovramp_b20_20250820.Rdat")

res_cov_b20_df %>%
  mutate(idx = 1:nrow(.)) %>%
  pivot_longer(cols=-c(idx, covrate)) %>%
  group_by(name, covrate) %>%
  summarize(truepos = mean(value < 0.05), .groups="drop") %>%
  ggplot(aes(x=covrate, y=truepos, col=name)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0.05, linetype='dashed') +
  theme_bw() +
  labs(title = 'OB FIXED BSAI', subtitle = '100 iterations, random trip sampling, -20% bias',
       x='coverage rate', y='true positive rate (p < 0.05)')


nreps = 200
res_cov_b20_df %>%
  mutate(idx = 1:nrow(.)) %>%
  pivot_longer(cols=-c(idx, covrate)) %>%
  group_by(name) %>%
  mutate(name = factor(name,
                       levels=c("p","uni.p.Pacific.Cod","uni.p.Pacific.Halibut","uni.p.Sablefish..blackcod."),
                       labels=c("overall p-value", "Pac. Cod (freq 63%, biom 81%)",
                                "Pac. Hal. (freq 26%, biom 5%)", "Sablefish (freq 31%, biom 13%)"))) %>%
  slice_sample(n = 50*nreps, replace=TRUE) %>%
  mutate(repnum = rep(1:nreps, each=50)) %>%
  group_by(repnum, name, covrate) %>%
  summarize(truepos = mean(value < 0.05), .groups="drop") %>%
  ggplot(aes(x=covrate, y=truepos)) +
  facet_wrap(~name, scales="free") +
  #geom_point(alpha = 0.02) +
  geom_boxplot(aes(group=covrate)) +
  #geom_smooth() +
  theme_bw() +
  labs(title = 'OB FIXED BSAI',
       subtitle = '50 iterations of random trip sampling, -20% bias, 200 bootstrap repeats',
       x='coverage rate', y='true positive rate (p < 0.05)'
       ) +
  geom_hline(yintercept = 0.05, linetype='dashed') +
  stat_summary(fun=mean, geom="line")
```

Real expected biases for OB FIXED BSAI
Spp     Freq    Biom(%) Bias %
P Cod   63.1    80.6      3.1
Sable   30.9    13.4     12.5
P Hal   26.2     5.4    -39.7
Oct     19.4     0.5     99.2
Arr Fl   3.1    <0.1    -88.5
Atk Mk   3.1    <0.1    -63.9
Oth Scu 19.1    <0.1    -12.4
P Perc   5.3    <0.1     90.5
Poll    12.2    <0.1     47.6
Rgh Rk   5.6    <0.1    196.7
Sh Rck   2.2    <0.1    600.2
Th Rck   5.6    <0.1    249.6
YE Rck   2.8    <0.1     81.4
YF Sol   4.4    <0.1    -48.0



#power by frequency or biomass -- SKIP FOR NOW
generate species with given biomass/frequency and run at 50% coverage (range of highest power)

run for single species from real data to make sure comparable results with both multi-species run and simulated biomass runs
```{r}
pdat %>%
  select(uid, days.fished, observed, BLOCK, `Pacific Cod`) %>%
  loop_mvglm(covrate=0.5, nperm=10, bias=0)
```

  
  
  # check if only a single species; if so, remove species from the model_call for tweedie profile
  nspp <- n_distinct(dat$species)
  if(nspp == 1) {
    model_call <- gsub("species \\+ ", "", model_call)
  } else {
    model_call <- model_call
  }


#next steps
**diversity/evenness vs. detection
high observer effect on low biomass species

perfect equitability w/ 10% or 30% OE
then make it lopside (gini 0.8, spp1 80%, spp2 15%, spp3 5%) 
how does overall p-value change?

**individual species in mvglm vs. individual OE tests
**combined species in mvglm vs. combined OE tests
  univariate compares combined weight vs. single weight

use simulated for sensitivity analysis
use real data for comparison to other methods

delta between overall p-value and most abundant species = advantage of multivariate test?
as a function of how those biomass differences are distributed?
does mv give a boost by considering contributions of other species


```{r}
res_cov_b20_resamp <- replicate(n=500, 
                        res_cov_b20_df %>%
                        mutate(idx = 1:nrow(.)) %>%
                        pivot_longer(cols=-c(idx, covrate)) %>%
                        group_by(name) %>%
                        group_by(covrate, name) %>%
                        sample_n(size=100, replace=TRUE) %>%
                        group_by(covrate, name) %>%
                        summarise(#t_test = mean(tp < 0.05, na.rm=TRUE),
                                  #f_test = mean(Fp < 0.05, na.rm=TRUE),
                                  #dAIC = mean(ifelse(glmmconv==1, AICd, NA) > aic_thresh, na.rm=TRUE),
                                  #KS_test = mean(KSp < 0.05, na.rm=TRUE),
                                  #median_test = mean(ci_lo > 0 | ci_hi < 0, na.rm=TRUE), 
                                  mvglm = mean(value < 0.05, na.rm=TRUE),
                                  .groups="drop"
                  ), simplify = FALSE) %>%
              Reduce(f=rbind)


res_cov_b20_resamp_summarized <- res_cov_b20_resamp %>%
  #pivot_longer(cols = -c(covrate), names_to = "test", values_to = "pct_pos") %>%
  rename(test = name, pct_pos = mvglm) %>%
  group_by(covrate, test) %>%
  summarise_all(list(q1=~quantile(., 0.025, na.rm = TRUE),
                     q2=~quantile(., 0.975, na.rm = TRUE)),
            .groups="drop") #%>%
  # mutate(test = factor(test, 
  #                      levels=c("t_test", "f_test", "dAIC", "KS_test", "median_test"), 
  #                      ordered=TRUE))


res_cov_b20_df %>%
  mutate(idx = 1:nrow(.)) %>%
  pivot_longer(cols=-c(idx, covrate)) %>%
  group_by(name) %>%
  group_by(covrate, name) %>%
  summarise(#t_test = mean(tp < 0.05, na.rm=TRUE),
            #f_test = mean(Fp < 0.05, na.rm=TRUE),
            #dAIC = mean(ifelse(glmmconv==1, AICd, NA) > aic_thresh, na.rm=TRUE),
            #KS_test = mean(KSp < 0.05, na.rm=TRUE),
            #median_test = mean(ci_lo > 0 | ci_hi < 0, na.rm=TRUE), 
            mvglm = mean(value < 0.05, na.rm=TRUE),
            .groups="drop"
            ) %>%
  #pivot_longer(cols=-c(pcov, pref, bias), names_to="test", values_to = "pct_pos") %>%
  #mutate(test = factor(test, 
  #                     levels=c("t_test", "f_test", "dAIC", "KS_test", "median_test"), 
  #                     ordered=TRUE)) %>%
  rename(test = name, pct_pos = mvglm) %>%
  inner_join(res_cov_b20_resamp_summarized, by=c("covrate", "test")) %>%
  #mutate(pref = factor(pref, levels = c("none", "high", "low"), ordered=TRUE)) %>%
  mutate(q1 = q1, q2 = q2) %>% #0.025 and 0.975
  #mutate(bias = factor(as.character(bias))) %>%
  #filter(bias %in% c("-0.5", "-0.3", "-0.1")) %>%
  #count(pcov, bias, pref, test)
  mutate(bias = "-0.2") %>%
  mutate(test = factor(test,
      levels=c("p","uni.p.Pacific.Cod","uni.p.Pacific.Halibut","uni.p.Sablefish..blackcod."),
      labels=c("overall p-value", "Pac. Cod", "Pac. Hal.", "Sablefish"))) %>%
  ggplot(aes(x=covrate, y=pct_pos, group=bias)) +
    geom_point(aes(col=bias)) +
    geom_line(aes(col=bias)) +
    geom_ribbon(aes(ymin=q1, ymax=q2, fill=bias), alpha = 0.2, stat="identity") +
    #facet_grid(pref~test, labeller=testlabels)+
    facet_grid(~test) +
    theme_bw() +
    labs(x="Coverage Rate", y="proportion of true positives", 
         col="Observer Effect", fill="Observer Effect") +
    # scale_color_manual(values=c("-0.1" = "#DCE319FF", "-0.3" = "#21908CFF", "-0.5" = "#440154FF"), 
    #                    labels=c("-0.1" = "-10%", "-0.3" = "-30%", "-0.5" = "-50%"),
    #                    aesthetics = c("color","fill")) +
    scale_x_continuous(labels = scales::percent, breaks = c(0.05, 0.45, 0.85), limits = c(-0.1,0.9)) +
  # geom_label(data = test_pref_matrix, inherit.aes = FALSE, aes(label = letter, x=-Inf, y=Inf, hjust = -0.25, vjust = 1.2), 
  #           label.padding = unit(0.2, "lines"), label.r = unit(0.3, "lines")) +
  theme(text = element_text(size=13),
        legend.position = "bottom")
```

