---
title: "delta vs dominance"
output: html_notebook
---

The goal is to see how detection rates differ for fisheries that are dominated by a single species vs. ones that are more even.

Simulation:
  2 species
  generate weights with varying levels of biomass allocated to species 1 (dominant)
  from mvglm, get delta between overall p-value and the p-value of the dominant species
  
```{r setup}
library(tidyverse)
library(FMAtools)  
library(mvobservr)
source("functions/mvglm_obs_dd.R")
source("functions/loop_mvglm.R")
```


```{r}
generate_spp_biomass <- function(nrec, mus) {
  df <- data.frame(uid = 1:nrec)
  for(i in 1:length(mus)) {
    df[,paste0("sp",i)] <- rtweedie(nrec, p=1.6, mu=mus[i], phi=5)
  }
  return(df)
}

```


```{r, warning=FALSE, message=FALSE, eval=FALSE}
nperm = 100 #about 1 minute for 100 permutations for 3 species
nrep = 20
n_species <- 2
n_records <- 300 #about 11 minutes for 100 reps

nrep/100*11/60*nperm/100 #estimated run hours at 1 min/100 perm
biasrate = -0.3

res_prop_b30 <- map(1:nrep, ~{
  #set up means for tweedie, with highest mean biomass sp first
  mu_values <- sort(rlnorm(n_species, meanlog = 2, sdlog = 1.5), decreasing=TRUE)
  
  #generate data and calculate proportions
  gen_dat <- generate_spp_biomass(n_records, mu_values)  
  props <- gen_dat %>%
    pivot_longer(-uid) %>%
    group_by(name) %>%
    summarize(total_biomass = sum(value), .groups="drop") %>%
    mutate(prop_biomass = total_biomass/sum(total_biomass)) %>%
    pivot_wider(names_from = name, values_from = c(total_biomass, prop_biomass))
  
  #pass generated data through mvglm
  gen_res <- gen_dat %>%
    mutate(BLOCK = "block", days.fished = 1) %>% #needed for mvglm_obs_dd
    loop_mvglm(covrate = 0.25, nperm = nperm, bias = biasrate) %>%
    pluck("ps") %>%
    rename_with(~str_c("p_", .x), -p) #append "p_" to species name
  
  cbind(props, gen_res)
  })

res_prop_b30_df <- list_rbind(res_prop_b30) %>%
  mutate(prop1_bin = trunc(prop_biomass_sp1/0.1,0)*0.1)

res_prop_b30_df %>%
  rowwise() %>%
  mutate(bp_index = max(c_across(starts_with("prop_"))),
         shannon_entropy = -sum(c_across(starts_with("prop_"))*log(c_across(starts_with("prop_")))),
         calculated_n1 = exp(shannon_entropy),
         richness = sum(c_across(starts_with("total_biomass"))),
         calculated_J = shannon_entropy / log(richness)
          # We add a very small number to proportions to avoid log(0) issues.
          # shannon_entropy <- -sum(proportions * log(proportions + 1e-9))
          # calculated_n1 <- exp(shannon_entropy)
          
          # Calculate Pielou's J'.
          # richness <- sum(biomass > 0)
          # if (richness <= 1) next # Evenness is undefined for 1 or 0 species.
          # calculated_J <- shannon_entropy / log(richness)
         ) %>%
  ungroup()

res_prop_b30_df %>%
  count(prop1_bin)

save(res_prop_b30_df, file="output_data/simdat2spp100rep100perm_propvar_b30_20250820.Rdat")

```

real weight example sums:
Pacific Cod       7783
Sablefish         1299
Pacific Halibut    514
Octopus             50



```{r}
res_prop_b30_df %>%
  mutate(delta = p - p_sp1) %>%
  ggplot(aes(x=prop_biomass_sp1, y=delta)) +
  geom_point(alpha = 0.5) +
  geom_smooth()
```

```{r}
res_prop_b30_df %>%
  select(prop1_bin, p, p_sp1, p_sp2) %>%
  pivot_longer(-prop1_bin) %>%
  filter(prop1_bin >= 0.5) %>%
  ggplot(aes(x=prop1_bin, y=value, group=prop1_bin)) +
  geom_boxplot() +
  #geom_jitter(alpha = 0.2, width=0.01) +
  facet_wrap(~name) +
  coord_cartesian(ylim=c(0,NA))
```

