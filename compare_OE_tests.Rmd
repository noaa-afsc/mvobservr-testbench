---
title: "comparison of observer effect tests"
output: html_notebook
---

Goal: compare outputs from mvglm to the 5 tests evaluated in Duarte & Cadrin

```{r setup}
library(tidyverse)
library(FMAtools)  
library(mvobservr)
library(lme4)
library(tweedie)
source("functions/mvglm_obs_dd.R")
source("functions/loop_mvglm.R")
source("functions/MakeTrips.R")
source("functions/obsSelect.R")
source("functions/AddBias.R")
source("functions/triplet_stats.R")
source("functions/TripletAnalysis.R")
source("functions/getDescriptiveStats.R")
source("functions/runTandFtests.R")
source("functions/runGLMM.R")
source("functions/assign_sig.R")
source("functions/tweedie_sim_generate_trips.R")
```

#testing incrementally to make sure all functions working as expected and distributions make sense

##data generation
```{r}
#check distributions of results
sum(rnbinom(20, size=4, prob=0.15)) #number of trips

test_trips <- map(1:30, ~MakeTrips(nvess = 20, tripsize=4, 
                                   tripprob=0.15, n_species = 2, mumean=2.8, 
                                   musd=0, tweedie_power = 1.6, tweedie_phi = 6)
                  ) %>%
  list_rbind(names_to = 'rep')

test_trips %>%
  group_by(rep) %>%
  summarize(n=n(), across(starts_with("sp_"), sum)) %>%
  mutate(prop1 = sp_1 / (sp_1 + sp_2)) %>%
  ggplot(aes(x=prop1)) +
  geom_histogram(bins=20, fill="lightblue", col="black") +
  labs(title = "distribution of species 1 proportion summed by rep")

test_trips %>%
  pivot_longer(cols=starts_with("sp")) %>%
  ggplot(aes(x=value+0.001)) +
  geom_histogram(bins=20, fill="lightblue", col="black") +
  scale_x_log10(labels=scales::label_comma()) +
  facet_wrap(~name, scales="free_y") +
  labs(title = "distribution of species weights by trip across all reps")

test_trips %>%
  pivot_longer(cols=starts_with("sp")) %>%
  group_by(name, rep) %>%
  summarize(n=n(),
            freq = mean(value > 0),
            mean = mean(value),
            median = median(value),
            sd = sd(value),
            sum = sum(value),
            .groups="drop")

```

##making trips
```{r}
MakeTrips(nvess = 20, tripsize=4, 
                                   tripprob=0.15, n_species = 2, mumean=2.8, 
                                   musd=0, tweedie_power = 1.4, tweedie_phi = 6) %>%
  #obsSelect(pcov = 0.25, preference = "low", prefby = "sp_2") %>%
  obsSelect(pcov = 0.25) %>%  
  group_by(vessnum) %>%
#  group_by(obs) %>%
    summarize(n=n(), mean(sp_1), mean(sp_2), sum(sp_1), sum(sp_2)) 
```

##adding bias
```{r}
MakeTrips(nvess = 20, tripsize=4, 
                                   tripprob=0.15, n_species = 2, mumean=2.8, 
                                   musd=1.5, tweedie_power = 1.4, tweedie_phi = 6) %>%
  obsSelect(pcov = 0.25) %>%
  AddBias(metric = c("sp_1","sp_2"), amount = -0.3) %>%
  group_by(obs) %>%
  summarize(n=n(), mean(sp_1), mean(sp_2))
```

##triplet analysis
```{r}
map(1:5, ~MakeTrips(nvess = 20, tripsize=4, 
                                   tripprob=0.15, n_species = 2, mumean=2.8, 
                                   musd=1.5, tweedie_power = 1.4, tweedie_phi = 6) %>%
  obsSelect(pcov = 0.25) %>%
  AddBias(metric = c("sp_1"), amount = -0.3) %>%
  rowwise() %>%
  mutate(biomass = sum(c_across(starts_with("sp_")))) %>%
  ungroup() %>%
  TripletAnalysis(metrics=c("sp_1","sp_2", "biomass"), bootstrap_reps = 100)
) %>%
  list_rbind()

```

```{r}
test_trips <- MakeTrips(nvess = 20, tripsize=4, 
                                   tripprob=0.15, n_species = 2, mumean=2.8, 
                                   musd=0, tweedie_power = 1.4, tweedie_phi = 6
                  ) %>%
  obsSelect(pcov = 0.25)
```


##descriptive stats
```{r}
getDescriptiveStats(test_trips, "sp_1")
getDescriptiveStats(test_trips, "sp_2")
```

##t and F tests
```{r}
runTandFtests(test_trips, "sp_1")
runTandFtests(test_trips, "sp_2")
```
##GLMM
```{r}
runGLMM(test_trips, "sp_1")
runGLMM(test_trips, "sp_2")
```

##mvglm
```{r}
test_trips %>%
    mutate(BLOCK = "block") %>% #needed for mvglm_obs_dd
    mutate(observed = ifelse(obs==1, 'Y', 'N')) %>%
    pivot_longer(cols=starts_with("sp_"),
                 names_to = 'species', values_to = 'biomass') %>%
    mvglm_obs_dd(block = "BLOCK", n_permutations=100) %>%
    pluck("ps") %>%
    rename(biomass_total = p) %>%
    pivot_longer(everything(), names_to = "metric", values_to = "mvglm_p") 
```


#permanova
```{r, eval=FALSE}
test_trips
Y <- test_trips %>% dplyr::select(starts_with("sp_"))
adon <- vegan::adonis2(Y ~ factor(obs), data = test_trips, permutations = 500, method="euclidean")
adon$`Pr(>F)`[1]
```


##all stats together
```{r}
test_trips <- test_trips %>%
    rowwise() %>%
    mutate(biomass_total = sum(c_across(starts_with("sp_")))) %>%
    ungroup() 
system.time(rr <- ObserverEffectStats(test_trips, metrics=c("sp_1","sp_2","biomass_total"), nboot_triplet=500, nperm_mvglm = 100, nperm_adon = 500))
rr #~80s

```

##assign significance values
```{r}
assign_sig(rr) %>%
  select(metric, mean_O, mean_U, ends_with("sig"))
```



#make trips first to get target distribution of proportions, then run through tests
how to do this by vessel? 
target proportion is based on TOTAL biomass over all trips, not vessel-specific or trip-specific
make set of trips (using MakeTrips function), then compare totals to target ratios, and keep or not keep (following tweedie_sim_generate_pops model)

**consider whether to keep fixed_total_biomass, which scales all records so that the total = target
  would not affect 0s
```{r generatedata, eval=FALSE}
# --- Simulation Setup ---

# Set the number of species to a more realistic value.
n_species <- 2
# Set how many valid communities we want to find for each target level.
n_samples_per_level <- 50
# Set the tolerance for matching the target Berger-Parker index.
# This needs to be small since our steps are small.
tolerance <- 0.005
# Set the Tweedie power parameter (lambda). 1 < p < 2 is typical for biomass.
tweedie_power <- 1.6
# Set the dispersion parameter for the Tweedie distribution.
# Higher values create more variance (more rare/dominant species).
phi <- 6
# Set the desired total biomass for every saved population.
fixed_total_biomass <- 10000
# for reproducibility
set.seed(123)

# Set the number of vessels in the fleet
nvess <- 20
# Set the parameters for defining the number of trips per vessel
tripsize <- 4; tripprob <- 0.15
# Set the mean and standard deviation for the mu parameters that are derived for each vessel (and fed into the Tweedie model)
# Higher SD will lead to more variability between vessels
mumean <- 2; musd <- 0


# --- Define Target Berger-Parker Levels ---

# Set target Berger-Parker index (dominance) levels.
target_bp_levels <- seq(0.5, 0.95, by = 0.05)

n_samples_per_level*length(target_bp_levels) #total simulated populations
n_samples_per_level*length(target_bp_levels)*1.5/60 #estimated hours to analyze all populations

# Set max attempts
max_attempts <- 3000000 # Set a generous ceiling for the total search.

trip_generation_results <- tweedie_sim_generate_trips(n_species, n_samples_per_level, tolerance, tweedie_power, phi, fixed_total_biomass, nvess, tripsize, tripprob, mumean, musd, target_bp_levels, max_attempts = max_attempts, seed = 123)


str(trip_generation_results$results_list, max.level = 2)
trip_generation_results$sample_counts

save(trip_generation_results, file="output_data/generated_trips_2spp_10Kbiomass_50perBP_20250916.Rdat")
```

###evaluate generated trips

```{r}
load("output_data/generated_trips_2spp_10Kbiomass_50perBP_20250916.Rdat")
trip_generation_results$results_list %>%
  list_rbind(names_to = "target_bp") %>%
  group_by(PopulationID) %>%
  summarize(across(c(starts_with("sp_"), "biomass_total"), .fns=list(mean=mean, sum=sum), .names="{.col}.{.fn}"),
            .groups="drop")

trip_generation_results$results_list %>%
  list_rbind(names_to = "target_bp") %>%
  group_by(PopulationID, vessnum) %>%
  summarize(across(c(starts_with("sp_"), "biomass_total"), .fns=list(mean=mean, sum=sum), .names="{.col}.{.fn}"),
            .groups="drop") %>%
  select(PopulationID, vessnum, ends_with("mean"), ends_with("sum")) %>%
  ggplot(aes(x=PopulationID, y=sp_1.mean)) +
  geom_jitter(width = 0.1, alpha = 0.2)
  
```
```{r}
trip_generation_results$results_list %>%
  list_rbind(names_to = "target_bp") %>%
  mutate(biomass_check = sp_1 + sp_2) %>%
  filter(round(biomass_total,6) != round(biomass_check,6))
```



####check for vessel effect
lm of catch ~ vessel is significant for vessel
```{r}
trip_generation_results$results_list %>%
  map(\(df) {split(x=df, f=df$PopulationID) %>%
              vctrs::list_drop_empty()%>%
              map(\(x) {lm(sp_1 ~ 1+factor(vessnum), data=x) %>%
                    anova() %>%
                    rownames_to_column() %>%
                    filter(rowname == "factor(vessnum)") %>%
                    select(p_vess = `Pr(>F)`) 
                 }) %>%
              list_rbind(names_to = "popID")
            }) %>%
  list_rbind(names_to="bp") %>%
  as.data.frame() %>%
  group_by(bp) %>%
  summarize(n=n(), nsig = sum(p_vess < 0.05), psig = mean(p_vess < 0.05))

trip_generation_results$results_list %>%
  map(\(df) {split(x=df, f=df$PopulationID) %>%
              vctrs::list_drop_empty()%>%
              map(\(x) {lm(sp_2 ~ 1+factor(vessnum), data=x) %>%
                    anova() %>%
                    rownames_to_column() %>%
                    filter(rowname == "factor(vessnum)") %>%
                    select(p_vess = `Pr(>F)`) 
                 }) %>%
              list_rbind(names_to = "popID")
            }) %>%
  list_rbind(names_to="bp") %>%
  as.data.frame() %>%
  group_by(bp) %>%
  summarize(n=n(), nsig = sum(p_vess < 0.05), psig = mean(p_vess < 0.05))

```


```{r}
dat <- results_split[[1]] %>%
  obsSelect(pcov = 0.5) %>%
  AddBias("sp_1", -0.5) 

dat[,"met"] <- dat[,"sp_1"]
  dat$metz <- dat$met + ifelse(dat$met==0,jitter(.001),0) #remove 0s for log link
  
  #filter out vessels with fewer than 2 observed or 2 unobserved trips
  dat2 <- dat %>%
    group_by(vessnum) %>%
    mutate(nobs=sum(obs==1), nunobs=sum(obs==0)) %>%
    filter(nobs>=2 & nunobs>=2) %>%
    ungroup()
  dat2$vessnum <- factor(dat2$vessnum)

  glmm1 <- lmer(metz~1+factor(obs) + (1|vessnum),
          data=transform(dat2, metz = log(metz)),
          REML = FALSE)
  glmm1.s <- summary(glmm1)
  glmm1u <- update(glmm1, metz ~ 1 + (1|vessnum)) #remove observer effect
  glmm1u.s <- summary(glmm1u)
  AIC1 <-  glmm1.s$AICtab[1]
  AIC2 <-  glmm1u.s$AICtab[1]
  (AICd <- AIC2 - AIC1)
  AIC(glmm1, glmm1u)
  factest <- glmm1.s$coef[2,1]
  factse <- glmm1.s$coef[2,2]
  glmmt <- glmm1.s$coef[2,3]
  glmmnves <- length(levels(dat2$vessnum))
  glmmntrp <- nrow(dat2)
  glmmconv <- ifelse(glmm1.s$optinfo$conv$opt == 0,1,0) #opt=0 means OK = converged

  confint(glmm1)
  (bhate = exp(factest) - 1)
  (bhatelo = exp(factest-1.96*factse) - 1)
  (bhatehi = exp(factest+1.96*factse) - 1)
  
  
  dat %>%
    group_by(vessnum, obs) %>%
    summarize(n=n(), mean(sp_1), sd(sp_1))
  
  dat_o <- dat
  dat <- dat %>%
    filter(!vessnum %in% c(5, 10, 12, 13, 19, 9, 7, 15, 16, 20, 8, 4, 3))
  
  dat %>%
    ggplot(aes(x=vessnum, col=factor(obs), group=obs, y=sp_1)) +
    geom_jitter(width = 0.2)
  
  dat %>%
    cbind(orig=results_split[[1]]$sp_1) %>%
    filter(vessnum == 13) %>%
    select(orig, sp_1, obs) %>%
    arrange(orig) 
  
  
  
dat %>%
    TripletAnalysis(metrics=c("sp_1"), bootstrap_reps = 2000)
```




##use generated trips in OE test loop
```{r warning=FALSE, message=FALSE, eval=FALSE}
nperm = 200 #1-1.5 minutes per rep for 100 permutations, 2 species, 7 tests, and 3 metrics
covrate = 0.5
biasrate = -0.3
nboot = 500

results_split <- trip_generation_results$results_list %>%
  list_rbind(names_to = "target_bp") %>%
  split(~PopulationID)


length(results_split)*1.5/60 #approximate run time in hours
#13.5 actual


system.time(res_OEall_b30sp1_gentrips_df <- map(results_split, ~{
  #select trips and add bias
  tripdat <- .x %>%
    obsSelect(pcov = covrate) %>%
    AddBias(metric = c("sp_1"), amount = biasrate) 
  
  #pass generated data through observer effect tests
  cbind(
    PopulationID = .x$PopulationID[1],
    target_bp = .x$target_bp[1],
    ObserverEffectStats(tripdat, metrics = c("sp_1","sp_2","biomass_total"), nperm_mvglm = nperm, nboot_triplet = nboot, nperm_adon=nboot)
    )
  
}) %>%
  list_rbind(names_to = "rep") %>%
  assign_sig() 
)


save(res_OEall_b30sp1_gentrips_df, file="output_data/simdat_2spp_50repperbp_200perm_OEtests_b30sp1_2025091620.Rdat")
```
note: GLMM will return "boundary (singular) fit" error if vessels are drawn from the same population (musd = 0) but results are still valid




```{r}
trip_generation_results$results_list %>%
  list_rbind(names_to = "target_bp") %>%
  filter(PopulationID == 2) %>%
  pivot_longer(cols = c(sp_1, sp_2, biomass_total)) %>%
  ggplot(aes(x=value)) +
  geom_histogram() +
  facet_wrap(~name) +
  labs(x="biomass", y="count of trips",
       title="example distribution for BP=0.5 (J=0.99)",
       subtitle = "totals: sp_1 = 5030, sp_2 = 4970")


trip_generation_results$results_list %>%
  list_rbind(names_to = "target_bp") %>%
  filter(PopulationID == 1) %>%
  pivot_longer(cols = c(sp_1, sp_2, biomass_total)) %>%
  ggplot(aes(x=value)) +
  geom_histogram() +
  facet_wrap(~name) +
  labs(x="biomass", y="count of trips",
       title="example distribution for BP=0.8 (J=0.72)",
       subtitle = "totals: sp_1 = 8027, sp_2 = 1973")


trip_generation_results$results_list %>%
  list_rbind(names_to = "target_bp") %>%
  filter(PopulationID == 500) %>%
  pivot_longer(cols = c(sp_1, sp_2, biomass_total)) %>%
  ggplot(aes(x=value)) +
  geom_histogram() +
  facet_wrap(~name) +
  labs(x="biomass", y="count of trips",
       title="example distribution for BP=0.95 (J=0.30)",
       subtitle = "totals: sp_1 = 9461, sp_2 = 539")



trip_generation_results$results_list %>%
  list_rbind(names_to = "target_bp") %>%
  group_by(PopulationID, target_bp) %>%
  summarize(across(c(starts_with("sp_"),"biomass_total"), sum), .groups="drop") %>%
  mutate(across(starts_with("sp_"), function(x) x/biomass_total, .names = "prop_{.col}")) %>%
  rowwise() %>%
  mutate(shannon_entropy = -sum(c_across(starts_with("prop_"))*log(c_across(starts_with("prop_")))),
         calculated_n1 = exp(shannon_entropy),
         calculated_J = shannon_entropy / log(2),
         calculated_bp = sp_1/biomass_total
  ) %>%
  ggplot(aes(x=calculated_bp, y=calculated_J)) + geom_point(alpha = 0.2)

```



```{r}
load("simdat_2spp_50repperbp_200perm_OEtests_b30sp1_20250916.Rdat")
res_OEall_b30sp1_gentrips_df %>%
  group_by(metric, target_bp) %>%
  summarize(across(ends_with("sig"), mean), .groups="drop")



res_OEall_b30sp1_gentrips_df %>%
  filter(metric == "biomass_total") %>%
  group_by(metric, target_bp) %>%
  summarize(across(ends_with("sig"), mean), .groups="drop") %>%
  pivot_longer(cols=ends_with("sig")) %>%
  ggplot(aes(x=target_bp, y=value, group=1)) +
  geom_point() +
  geom_line() +
  facet_wrap(~name)

res_OEall_b30sp1_gentrips_df %>%
  filter(metric == "biomass_total") %>%
  ggplot(aes(x=mvglm_p, y=perma_p, col=target_bp)) +
  geom_jitter(width = 0.002) +
  geom_abline() +
  geom_hline(yintercept = 0.05, linetype = 'dashed') +
  geom_vline(xintercept = 0.05, linetype = 'dashed') +
  labs(x = "p-value from mvglm", y="p-value from permanova")


res_OEall_b30sp1_gentrips_df %>%
  group_by(metric) %>%
  summarize(cr = cor(dAIC_sig, median_test_sig))

res_OEall_b30sp1_gentrips_df %>%
  filter(metric == "biomass_total") %>%
  summarize(cr = cor(mvglm_sig, perma_sig))
```

```{r, fig.width=10, fig.height=8}
bootstrap_size = 50
n_bootstraps = 500

res_OEall_b30sp1_gentrips_df %>%
  select(target_bp, metric, ends_with("sig")) %>%
  filter(metric == 'biomass_total') %>%
  mutate(bin = as.factor(target_bp)) %>%
  split(~bin) %>%
  map(.x=., .f=~{slice_sample(.x, n=bootstrap_size*n_bootstraps, replace=TRUE) %>%
      mutate(boot = rep(1:n_bootstraps, each=bootstrap_size)) %>%
      group_by(metric, bin, boot) %>%
      summarize(across(ends_with("sig"), mean), 
                .groups="drop")
    }) %>%
  list_rbind() %>%
  pivot_longer(cols=ends_with("sig"), names_to = "test", values_to = "pct_sig") %>%
  mutate(test = factor(test, levels=c("t_test_sig", "f_test_sig", "dAIC_sig", "KS_test_sig", "median_test_sig", "perma_sig", "mvglm_sig"),
                       ordered = TRUE,
                       labels = c("t test", "F test", "GLMM", "KS test", "median diff.", "permanova", "MVGLM"))) %>%
  group_by(metric, bin, test) %>%
      summarize(power=mean(pct_sig),
                cilo = quantile(pct_sig, 0.025),
                cihi = quantile(pct_sig, 0.975),
                n=n(),
                .groups="drop") %>%
  filter(test %in% c("t test", "F test", "permanova", "MVGLM")) %>%
  ggplot(aes(x=bin, y=power, ymin=cilo, ymax=cihi, group=1)) +
  geom_point() +
  geom_line() +
  geom_ribbon(alpha = 0.2) +
  facet_wrap(~test) +
  labs(x="species 1 biomass as proprotion of total biomass",
       y="power (proportion of iterations with significant result)",
       title="Generated data using Tweedie model",
       subtitle = "50 iterations per proportion, 50% coverage, -30% observer effect on species 1, 200 permutations, 500 bootstraps, no vessel effect") +
  theme_bw() +
  coord_cartesian(ylim=c(0,1))


res_OEall_b30sp1_gentrips_df %>%
  select(target_bp, metric, ends_with("sig")) %>%
  filter(metric == 'biomass_total') %>%
  mutate(bin = as.factor(target_bp)) %>%
  split(~bin) %>%
  map(.x=., .f=~{slice_sample(.x, n=bootstrap_size*n_bootstraps, replace=TRUE) %>%
      mutate(boot = rep(1:n_bootstraps, each=bootstrap_size)) %>%
      group_by(metric, bin, boot) %>%
      summarize(across(ends_with("sig"), mean), 
                .groups="drop")
    }) %>%
  list_rbind() %>%
  pivot_longer(cols=ends_with("sig"), names_to = "test", values_to = "pct_sig") %>%
  mutate(test = factor(test, levels=c("t_test_sig", "f_test_sig", "dAIC_sig", "KS_test_sig", "median_test_sig", "perma_sig", "mvglm_sig"),
                       ordered = TRUE,
                       labels = c("t test", "F test", "GLMM", "KS test", "median diff.", "permanova", "MVGLM"))) %>%
  group_by(metric, bin, test) %>%
      summarize(power=mean(pct_sig),
                cilo = quantile(pct_sig, 0.025),
                cihi = quantile(pct_sig, 0.975),
                n=n(),
                .groups="drop") %>%
  filter(test %in% c("t test", "F test", "permanova", "MVGLM")) %>%
  ggplot(aes(x=bin, y=power, ymin=cilo, ymax=cihi, group=test, col=test, fill=test)) +
  geom_point() +
  geom_line() +
  #geom_ribbon(alpha = 0.2) +
  labs(x="species 1 biomass as proprotion of total biomass",
       y="power (proportion of iterations with significant result)",
       title="Generated data using Tweedie model",
       subtitle = "50 iterations per proportion, 50% coverage, -30% observer effect on species 1, 200 permutations, 500 bootstraps, no vessel effect") +
  theme_bw() +
  coord_cartesian(ylim=c(0,1))


res_OEall_b30sp1_gentrips_df %>%
  select(PopulationID, target_bp, metric, tp, Fp, mvglm_p, perma_p)
```
t-test and F-test are on total biomass, permanova and mvglm are on both sp_1 and sp_2
GLMM and triplet analyses not shown because they had very low power for both
  possibly due to the higher intra- vs. inter-vessel variation
        OR the tweedie distribution with large 0s (previous was delta-lognormal)



```{r}
trips <- trip_generation_results$results_list[[1]] %>%
  filter(PopulationID == 2) %>%
  obsSelect(pcov = 0.25) %>%
  AddBias("sp_1", -0.3)
Y <- trips %>% dplyr::select(starts_with("sp_"))
  adon <- vegan::adonis2(Y ~ factor(obs), data = trips, permutations = 500, method="euclidean")
  permanova <- data.frame(metric = "biomass_total", perma_p = adon$`Pr(>F)`[1])
  
 mvglmobs_res <- trips %>%
    mutate(BLOCK = "block") %>% #needed for mvglm_obs_dd
    mutate(observed = ifelse(obs==1, 'Y', 'N')) %>%
    pivot_longer(cols=starts_with("sp_"),
                 names_to = 'species', values_to = 'biomass') %>%
    mvglm_obs_dd(block = "BLOCK", n_permutations=200) %>%
    pluck("ps") %>%
    rename(biomass_total = p) %>%
    pivot_longer(everything(), names_to = "metric", values_to = "mvglm_p") 
  
```




```{r warning=FALSE, message=FALSE, eval=FALSE}
nperm = 200 #1-1.5 minutes per rep for 100 permutations, 2 species, 7 tests, and 3 metrics
covrate = 0.5
biasrate = -0.3
nboot = 500

results_split <- trip_generation_results$results_list %>%
  list_rbind(names_to = "target_bp") %>%
  split(~PopulationID)


length(results_split)*1.5/60 #approximate run time in hours
#13.5 actual


system.time(res_OEall_b30sp2_gentrips_df <- map(results_split, ~{
  #select trips and add bias
  tripdat <- .x %>%
    obsSelect(pcov = covrate) %>%
    AddBias(metric = c("sp_2"), amount = biasrate) 
  
  #pass generated data through observer effect tests
  cbind(
    PopulationID = .x$PopulationID[1],
    target_bp = .x$target_bp[1],
    ObserverEffectStats(tripdat, metrics = c("sp_1","sp_2","biomass_total"), nperm_mvglm = nperm, nboot_triplet = nboot, nperm_adon=nboot)
    )
  
}) %>%
  list_rbind(names_to = "rep") %>%
  assign_sig() 
)


save(res_OEall_b30sp2_gentrips_df, file="output_data/simdat_2spp_50repperbp_200perm_OEtests_b30sp2_2025091621.Rdat")
```



```{r, fig.width=10, fig.height=8}
load("output_data/simdat_2spp_50repperbp_200perm_OEtests_b30sp2_2025091621.Rdat")
bootstrap_size = 50
n_bootstraps = 500

res_OEall_b30sp2_gentrips_df %>%
  select(target_bp, metric, ends_with("sig")) %>%
  filter(metric == 'biomass_total') %>%
  mutate(bin = as.factor(as.numeric(target_bp))) %>%
  split(~bin) %>%
  map(.x=., .f=~{slice_sample(.x, n=bootstrap_size*n_bootstraps, replace=TRUE) %>%
      mutate(boot = rep(1:n_bootstraps, each=bootstrap_size)) %>%
      group_by(metric, bin, boot) %>%
      summarize(across(ends_with("sig"), mean), 
                .groups="drop")
    }) %>%
  list_rbind() %>%
  pivot_longer(cols=ends_with("sig"), names_to = "test", values_to = "pct_sig") %>%
  mutate(test = factor(test, levels=c("t_test_sig", "f_test_sig", "dAIC_sig", "KS_test_sig", "median_test_sig", "perma_sig", "mvglm_sig"),
                       ordered = TRUE,
                       labels = c("t test", "F test", "GLMM", "KS test", "median diff.", "permanova", "MVGLM"))) %>%
  group_by(metric, bin, test) %>%
      summarize(power=mean(pct_sig),
                cilo = quantile(pct_sig, 0.025),
                cihi = quantile(pct_sig, 0.975),
                n=n(),
                .groups="drop") %>%
  #filter(test %in% c("t test", "F test", "permanova", "MVGLM")) %>%
  ggplot(aes(x=bin, y=power, ymin=cilo, ymax=cihi, group=1)) +
  geom_point() +
  geom_line() +
  geom_ribbon(alpha = 0.2) +
  facet_wrap(~test) +
  labs(x="species 1 biomass as proprotion of total biomass",
       y="power (proportion of iterations with significant result)",
       title="Generated data using Tweedie model",
       subtitle = "50 iterations per proportion, 50% coverage, -30% observer effect on species 2, 200 permutations, 500 bootstraps, no vessel effect") +
  theme_bw() +
  coord_cartesian(ylim=c(0,1))

```

mvglm performs better than other tests when the species with the bias (in this case sp_2) is not well represented in the population






***what if the bias is different by vessel?
1 - have single bias rate for vessels with similar catches
2 - have single bias rate for vessels with different catches
3 - have variable bias rate for vessels with similar catches
4 - have variable bias rate for vessels with different catches (by vessel size?)

block = target (accounts for variables like duration, vessel size, distance offshore)


do vessel draws first and comprae how similar they are? or compare homogeneity within each simulated population

how confident can we be in the mvglm outputs
if my most abundant species is at least 50% of the catch, I can detect with 80% confidence a 20% observer effect 

real-life distribution has tweedie dist of 1.63


dominant species percent vs. minimum detectable effect size




hypothesis:
single species p-values should be similar to univariate tests for that species
multivariate p-value should be more powerful than summed-biomass univariate test at higher values of evenness (lower bp)

























```{r}
# --- Simulation Setup ---

# Set the number of species to a more realistic value.
n_species <- 2
# Set how many valid communities we want to find for each target level.
n_samples_per_level <- 5
# Set the tolerance for matching the target Berger-Parker index.
# This needs to be small since our steps are small.
tolerance <- 0.04
# Set the Tweedie power parameter (lambda). 1 < p < 2 is typical for biomass.
tweedie_power <- 1.6
# Set the dispersion parameter for the Tweedie distribution.
# Higher values create more variance (more rare/dominant species).
phi <- 6
# Set the desired total biomass for every saved population.
fixed_total_biomass <- 10000
# for reproducibility
set.seed(123)

# Set the number of vessels in the fleet
nvess <- 20
# Set the parameters for defining the number of trips per vessel
tripsize <- 4; tripprob <- 0.15
# Set the mean and standard deviation for the mu parameters that are derived for each vessel (and fed into the Tweedie model)
# Higher SD will lead to more variability between vessels
mumean <- 2; musd <- 1


# --- Define Target Berger-Parker Levels ---

# Set target Berger-Parker index (dominance) levels.
target_bp_levels <- seq(0.5, 0.95, by = 0.1)

n_samples_per_level*length(target_bp_levels) #total simulated populations
n_samples_per_level*length(target_bp_levels)*1.5/60 #estimated hours to analyze all populations

# Set max attempts
max_attempts <- 300 # Set a generous ceiling for the total search.

trip_generation_results2 <- tweedie_sim_generate_trips(n_species, n_samples_per_level, tolerance, tweedie_power, phi, fixed_total_biomass, nvess, tripsize, tripprob, mumean, musd, target_bp_levels, max_attempts = max_attempts, seed = 123)
```

```{r}
results_split2 <- trip_generation_results2$results_list %>%
  list_rbind(names_to = "target_bp") %>%
  split(~PopulationID)

system.time(res_OEall_b30sp1_gentrips_df2 <- map(results_split2, ~{
  #select trips and add bias
  tripdat <- .x %>%
    obsSelect(pcov = covrate) %>%
    AddBias(metric = c("sp_1"), amount = biasrate) 
  
  #pass generated data through observer effect tests
  cbind(
    PopulationID = .x$PopulationID[1],
    target_bp = .x$target_bp[1],
    ObserverEffectStats(tripdat, metrics = c("sp_1","sp_2","biomass_total"), nperm_mvglm = nperm, nboot_triplet = nboot, nperm_adon=nboot)
    )
  
}) %>%
  list_rbind(names_to = "rep") %>%
  assign_sig() 
) #1hr


res_OEall_b30sp1_gentrips_df2 %>%
  filter(metric == "biomass_total") %>%
  select(metric, target_bp, tp, Fp, AICd, median_diff, KSp, mvglm_p, perma_p, ends_with("sig")) %>%
  arrange(metric, target_bp)

```



```{r}
results_split2 <- trip_generation_results2$results_list %>%
  list_rbind(names_to = "target_bp") %>%
  split(~PopulationID)

system.time(res_OEall_b30sp1_gentrips_df2 <- map(results_split2, ~{
  #select trips and add bias
  tripdat <- .x %>%
    obsSelect(pcov = covrate) %>%
    AddBias(metric = c("sp_1"), amount = biasrate) %>%
    mutate(BLOCK = vessnum)
  
  #pass generated data through observer effect tests
  cbind(
    PopulationID = .x$PopulationID[1],
    target_bp = .x$target_bp[1],
    ObserverEffectStats(tripdat, metrics = c("sp_1","sp_2","biomass_total"), nperm_mvglm = nperm, nboot_triplet = nboot, nperm_adon=nboot, mv_block = "BLOCK", mv_addvar = "days.fished")
    )
  
}) %>%
  list_rbind(names_to = "rep") %>%
  assign_sig() 
)


res_OEall_b30sp1_gentrips_df2 %>%
  select(metric, target_bp, tp, Fp, AICd, median_diff, KSp, mvglm_p, perma_p) %>%
  arrange(metric, target_bp)
```

