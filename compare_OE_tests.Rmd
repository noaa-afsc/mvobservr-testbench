---
title: "comparison of observer effect tests"
output: html_notebook
---

Goal: compare outputs from mvglm to the 5 tests evaluated in Duarte & Cadrin

```{r setup}
library(tidyverse)
library(FMAtools)  
library(mvobservr)
library(lme4)
library(tweedie)
source("functions/mvglm_obs_dd.R")
source("functions/loop_mvglm.R")
source("functions/MakeTrips.R")
source("functions/obsSelect.R")
source("functions/AddBias.R")
source("functions/triplet_stats.R")
source("functions/TripletAnalysis.R")
source("functions/getDescriptiveStats.R")
source("functions/runTandFtests.R")
source("functions/runGLMM.R")
source("functions/assign_sig.R")
source("functions/tweedie_sim_generate_trips.R")
```

#testing incrementally to make sure all functions working as expected and distributions make sense

##data generation
```{r}
#check distributions of results
sum(rnbinom(20, size=4, prob=0.15)) #number of trips

test_trips <- map(1:30, ~MakeTrips(nvess = 20, tripsize=4, 
                                   tripprob=0.15, n_species = 2, mumean=2.8, 
                                   musd=0, tweedie_power = 1.4, tweedie_phi = 6)
                  ) %>%
  list_rbind(names_to = 'rep')

test_trips %>%
  group_by(rep) %>%
  summarize(n=n(), across(starts_with("sp_"), sum)) %>%
  mutate(prop1 = sp_1 / (sp_1 + sp_2)) %>%
  ggplot(aes(x=prop1)) +
  geom_histogram(bins=20, fill="lightblue", col="black") +
  labs(title = "distribution of species 1 proportion summed by rep")

test_trips %>%
  pivot_longer(cols=starts_with("sp")) %>%
  ggplot(aes(x=value+0.001)) +
  geom_histogram(bins=20, fill="lightblue", col="black") +
  scale_x_log10(labels=scales::label_comma()) +
  facet_wrap(~name, scales="free_y") +
  labs(title = "distribution of species weights by trip across all reps")

test_trips %>%
  pivot_longer(cols=starts_with("sp")) %>%
  group_by(name, rep) %>%
  summarize(n=n(),
            freq = mean(value > 0),
            mean = mean(value),
            median = median(value),
            sd = sd(value),
            sum = sum(value),
            .groups="drop")

```

##making trips
```{r}
MakeTrips(nvess = 20, tripsize=4, 
                                   tripprob=0.15, n_species = 2, mumean=2.8, 
                                   musd=0, tweedie_power = 1.4, tweedie_phi = 6) %>%
  #obsSelect(pcov = 0.25, preference = "low", prefby = "sp_2") %>%
  obsSelect(pcov = 0.25) %>%  
  group_by(vessnum) %>%
#  group_by(obs) %>%
    summarize(n=n(), mean(sp_1), mean(sp_2), sum(sp_1), sum(sp_2)) 
```

##adding bias
```{r}
MakeTrips(nvess = 20, tripsize=4, 
                                   tripprob=0.15, n_species = 2, mumean=2.8, 
                                   musd=1.5, tweedie_power = 1.4, tweedie_phi = 6) %>%
  obsSelect(pcov = 0.25) %>%
  AddBias(metric = c("sp_1","sp_2"), amount = -0.3) %>%
  group_by(obs) %>%
  summarize(n=n(), mean(sp_1), mean(sp_2))
```

##triplet analysis
```{r}
map(1:5, ~MakeTrips(nvess = 20, tripsize=4, 
                                   tripprob=0.15, n_species = 2, mumean=2.8, 
                                   musd=1.5, tweedie_power = 1.4, tweedie_phi = 6) %>%
  obsSelect(pcov = 0.25) %>%
  AddBias(metric = c("sp_1"), amount = -0.3) %>%
  rowwise() %>%
  mutate(biomass = sum(c_across(starts_with("sp_")))) %>%
  ungroup() %>%
  TripletAnalysis(metrics=c("sp_1","sp_2", "biomass"), bootstrap_reps = 100)
) %>%
  list_rbind()

```

```{r}
test_trips <- MakeTrips(nvess = 20, tripsize=4, 
                                   tripprob=0.15, n_species = 2, mumean=2.8, 
                                   musd=0, tweedie_power = 1.4, tweedie_phi = 6
                  ) %>%
  obsSelect(pcov = 0.25)
```


##descriptive stats
```{r}
getDescriptiveStats(test_trips, "sp_1")
getDescriptiveStats(test_trips, "sp_2")
```

##t and F tests
```{r}
runTandFtests(test_trips, "sp_1")
runTandFtests(test_trips, "sp_2")
```
##GLMM
```{r}
runGLMM(test_trips, "sp_1")
runGLMM(test_trips, "sp_2")
```

##mvglm
```{r}
test_trips %>%
    mutate(BLOCK = "block") %>% #needed for mvglm_obs_dd
    mutate(observed = ifelse(obs==1, 'Y', 'N')) %>%
    pivot_longer(cols=starts_with("sp_"),
                 names_to = 'species', values_to = 'biomass') %>%
    mvglm_obs_dd(block = "BLOCK", n_permutations=100) %>%
    pluck("ps") %>%
    rename(biomass_total = p) %>%
    pivot_longer(everything(), names_to = "metric", values_to = "mvglm_p") 
```


#permanova
```{r, eval=FALSE}
test_trips
Y <- test_trips %>% dplyr::select(starts_with("sp_"))
adon <- vegan::adonis2(Y ~ factor(obs), data = test_trips, permutations = 500, method="euclidean")
adon$`Pr(>F)`[1]
```


##all stats together
```{r}
test_trips <- test_trips %>%
    rowwise() %>%
    mutate(biomass_total = sum(c_across(starts_with("sp_")))) %>%
    ungroup() 
system.time(rr <- ObserverEffectStats(test_trips, metrics=c("sp_1","sp_2","biomass_total"), nboot_triplet=500, nperm_mvglm = 100))
rr #~80s

```

##assign significance values
```{r}
assign_sig(rr) %>%
  select(metric, mean_O, mean_U, ends_with("sig"))
```



#putting it all together
```{r, eval=FALSE}
nperm = 100 #1-1.5 minutes per rep for 100 permutations, 2 species, 6 tests, and 3 metrics
nrep = 500
covrate = 0.25
biasrate = -0.3
nboot = 500

system.time( res_OEall_b30_df <- map(1:nrep, ~{
  #generate data
  gen_dat <- MakeTrips(nvess = 20, tripsize=4, 
                                   tripprob=0.15, n_species = 2, mumean=2.8, 
                                   musd=1.5, tweedie_power = 1.4, tweedie_phi = 6) %>%
    obsSelect(pcov = covrate) %>%
    AddBias(metric = c("sp_1"), amount = biasrate) %>%
    rowwise() %>%
    mutate(biomass_total = sum(c_across(starts_with("sp_")))) %>%
    ungroup() 
  
  #pass generated data through observer effect tests
  rbind(
    ObserverEffectStats(gen_dat, metrics = c("sp_1","sp_2","biomass_total"), nperm_mvglm = nperm, nboot_triplet = nboot)
    )
}) %>%
  list_rbind(names_to = "rep") %>%
  assign_sig() 
)


#permanova -- look into adding this for comparison
save(res_OEall_b30_df, file="output_data/simdat2spp500rep100perm_OEtests_b30_20250827.Rdat")

```



```{r}
load("output_data/simdat2spp500rep100perm_OEtests_b30_20250827.Rdat")
res_OEall_b30_df

res_OEall_b30_df <- res_OEall_b30_df %>%
  group_by(rep) %>%
  mutate(biomass_total = max(sum_O) + max(sum_U), 
         biomass_sp_1 = max(ifelse(metric == "sp_1", sum_O, 0)) + max(ifelse(metric == "sp_1", sum_U, 0)),
         prop_sp_1 = biomass_sp_1 / biomass_total, #weight of species1 as proportion of total biomass
         prop_sp_2 = 1 - prop_sp_1 #only if 2 species
         ) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(bp_index = max(c_across(starts_with("prop_"))),
         shannon_entropy = -sum(c_across(starts_with("prop_"))*log(c_across(starts_with("prop_")))),
         calculated_n1 = exp(shannon_entropy),
         richness = biomass_total,
         calculated_J = shannon_entropy / log(richness)
          # We add a very small number to proportions to avoid log(0) issues.
          # shannon_entropy <- -sum(proportions * log(proportions + 1e-9))
          # calculated_n1 <- exp(shannon_entropy)
          
          # Calculate Pielou's J'.
          # richness <- sum(biomass > 0)
          # if (richness <= 1) next # Evenness is undefined for 1 or 0 species.
          # calculated_J <- shannon_entropy / log(richness)
         ) %>%
  ungroup()

res_OEall_b30_df %>%
  group_by(metric) %>%
  summarize(mean(sum_O + sum_U),
            sd(sum_O + sum_U))
```

```{r}
res_OEall_b30_df %>%
  select(rep, metric, ends_with("sig")) %>%
  group_by(metric) %>%
  summarize(across(ends_with("sig"), mean, .groups="drop"))

res_OEall_b30_df %>%
  group_by(metric) %>%
  summarize(across(c(prop_sp_1, mean_O, mean_U, tp, Fp, KSp, AICd, median_diff, mvglm_p), mean, .groups="drop"))
```


```{r, fig.width = 8, fig.height=6}
bootstrap_size = 200
n_bootstraps = 500

res_OEall_b30_df %>%
  mutate(bin = trunc(prop_sp_1/0.05,0)*0.05)  %>%
  #mutate(bin = trunc(calculated_J/0.01, 0)*0.01) %>%
  select(rep, bin, metric, ends_with("sig")) %>%
  mutate(bin = as.factor(bin)) %>%
  split(~bin) %>%
  map(.x=., .f=~{slice_sample(.x, n=bootstrap_size*n_bootstraps, replace=TRUE) %>%
      mutate(boot = rep(1:n_bootstraps, each=bootstrap_size)) %>%
      group_by(metric, bin, boot) %>%
      summarize(across(ends_with("sig"), mean), .groups="drop")
    }) %>%
  list_rbind() %>%
  pivot_longer(cols=ends_with("sig"), names_to = "test", values_to = "sigrate") %>%
  group_by(metric, bin, test) %>%
      summarize(power=mean(sigrate),
                cilo = quantile(sigrate, 0.025),
                cihi = quantile(sigrate, 0.975),
                n=n(),
                .groups="drop") %>%
  mutate(test = factor(test, levels = c("t_test_sig", "f_test_sig", "dAIC_sig", "KS_test_sig", "median_test_sig", "mvglm_sig"),
                       ordered = TRUE,
                       labels = c("t test", "F test", "GLMM", "KS", "median diff.", "mvglm"))) %>%
  ggplot(aes(x=bin, y=power, ymin=cilo, ymax=cihi, col=metric, fill=metric, group=metric)) +
  geom_point() +
  geom_line() +
  geom_ribbon(alpha = 0.2) +
  labs(x="species 1 biomass as proprotion of total biomass",
       y="power (proportion of iterations with significant result)",
       title="Generated data using Tweedie model",
       subtitle = "200 iterations, 25% coverage, -30% bias on sp1 only, 100 permutations, 500 bootstraps") +
  theme_bw() +
  coord_cartesian(ylim=c(0,1)) +
  facet_wrap(~test) +
  theme(legend.position = "bottom")

res_OEall_b30_df %>%
  mutate(bin = trunc(prop_sp_1/0.05,0)*0.05) %>%
  count(bin)
```




#make trips first to get target distribution of proportions, then run through tests
how to do this by vessel? 
target proportion is based on TOTAL biomass over all trips, not vessel-specific or trip-specific
make set of trips (using MakeTrips function), then compare totals to target ratios, and keep or not keep (following tweedie_sim_generate_pops model)

**consider whether to keep fixed_total_biomass, which scales all records so that the total = target
  would not affect 0s
```{r}
# --- Simulation Setup ---

# Set the number of species to a more realistic value.
n_species <- 2
# Set how many valid communities we want to find for each target level.
n_samples_per_level <- 5#00
# Set the tolerance for matching the target Berger-Parker index.
# This needs to be small since our steps are small.
tolerance <- 0.005
# Set the Tweedie power parameter (lambda). 1 < p < 2 is typical for biomass.
tweedie_power <- 1.6
# Set the dispersion parameter for the Tweedie distribution.
# Higher values create more variance (more rare/dominant species).
phi <- 6
# Set the desired total biomass for every saved population.
fixed_total_biomass <- 10000
# for reproducibility
set.seed(123)

# Set the number of vessels in the fleet
nvess <- 20
# Set the parameters for defining the number of trips per vessel
tripsize <- 4; tripprob <- 0.15
# Set the mean and standard deviation for the mu parameters that are derived for each vessel (and fed into the Tweedie model)
# Higher SD will lead to more variability between vessels
mumean <- 2; musd <- 0


# --- Define Target Berger-Parker Levels ---

# Set target Berger-Parker index (dominance) levels.
target_bp_levels <- seq(0.5, 0.95, by = 0.05)

# Set max attempts
max_attempts <- 500 #3000000 # Set a generous ceiling for the total search.

trip_generation_results <- tweedie_sim_generate_trips(n_species, n_samples_per_level, tolerance, tweedie_power, phi, fixed_total_biomass, nvess, tripsize, tripprob, mumean, musd, target_bp_levels, max_attempts = max_attempts, seed = 123)


str(trip_generation_results$results_list, max.level = 2)
trip_generation_results$sample_counts


```

###evaluate generated trips

```{r}
trip_generation_results$results_list %>%
  list_rbind(names_to = "target_bp") %>%
  group_by(PopulationID) %>%
  summarize(across(c(starts_with("sp_"), "biomass_total"), .fns=list(mean=mean, sum=sum), .names="{.col}.{.fn}"),
            .groups="drop")

trip_generation_results$results_list %>%
  list_rbind(names_to = "target_bp") %>%
  group_by(PopulationID, vessnum) %>%
  summarize(across(c(starts_with("sp_"), "biomass_total"), .fns=list(mean=mean, sum=sum), .names="{.col}.{.fn}"),
            .groups="drop") %>%
  select(PopulationID, vessnum, ends_with("mean"), ends_with("sum")) %>%
  ggplot(aes(x=PopulationID, y=sp_1.mean)) +
  geom_jitter(width = 0.1)
  
```
```{r}
trip_generation_results$results_list %>%
  list_rbind(names_to = "target_bp") %>%
  mutate(biomass_check = sp_1 + sp_2) %>%
  filter(round(biomass_total,6) != round(biomass_check,6))
```



####check for vessel effect
lm of catch ~ vessel is significant for vessel
```{r}
trip_generation_results$results_list %>%
  map(\(df) {split(x=df, f=df$PopulationID) %>%
              vctrs::list_drop_empty()%>%
              map(\(x) {lm(sp_1 ~ 1+factor(vessnum), data=x) %>%
                    anova() %>%
                    rownames_to_column() %>%
                    filter(rowname == "factor(vessnum)") %>%
                    select(p_vess = `Pr(>F)`) 
                 }) %>%
              list_rbind(names_to = "popID")
            }) %>%
  list_rbind(names_to="bp")

trip_generation_results$results_list %>%
  map(\(df) {split(x=df, f=df$PopulationID) %>%
              vctrs::list_drop_empty()%>%
              map(\(x) {lm(sp_2 ~ 1+factor(vessnum), data=x) %>%
                    anova() %>%
                    rownames_to_column() %>%
                    filter(rowname == "factor(vessnum)") %>%
                    select(p_vess = `Pr(>F)`) 
                 }) %>%
              list_rbind(names_to = "popID")
            }) %>%
  list_rbind(names_to="bp")

```



```{r}
 
  #select trips and add bias
  tripdat <- results_split[[1]] %>%
    obsSelect(pcov = 0.25) %>%
    AddBias(metric = c("sp_1"), amount = -0.3) 

runGLMM(tripdat, "sp_1")

  tripdat[,"met"] <- tripdat[,"sp_1"]
  tripdat$metz <- tripdat$met + ifelse(tripdat$met==0,jitter(.001),0) #remove 0s for log link
  
  #filter out vessels with fewer than 2 observed or 2 unobserved trips
  tripdat2 <- tripdat %>%
    group_by(vessnum) %>%
    mutate(nobs=sum(obs==1), nunobs=sum(obs==0)) %>%
    filter(nobs>=3 & nunobs>=3) %>%
    ungroup()
  tripdat2$vessnum <- factor(tripdat2$vessnum) 
  tripdat2$obs <- factor(tripdat2$obs)
  
  glmm1 <- lmer(metz~1+ obs + (1|vessnum),
          data=transform(tripdat2, metz = log(metz)),
          REML = FALSE)
  glmm1u <- update(glmm1, metz~1 + (1|vessnum)) #remove observer effect
  summary(glmm1)$AICtab[1]
  summary(glmm1u)$AICtab[1]
  AICs <- AIC(glmm1, glmm1u)$AIC

glmm2 <- lmer(log(metz) ~ 1 + obs + (1|vessnum), 
              data = tripdat2, 
              REML = FALSE,
              control = lmerControl(optimizer = "optimx", optCtrl = list(method = "nlminb")))
  
```





##use generated trips in OE test loop
```{r}
nperm = 100 #1-1.5 minutes per rep for 100 permutations, 2 species, 6 tests, and 3 metrics
covrate = 0.5
biasrate = -0.5
nboot = 500

results_split <- trip_generation_results$results_list %>%
  list_rbind(names_to = "target_bp") %>%
  split(~PopulationID)


res_OEall_b30_gentrips_df <- map(results_split, ~{
  #select trips and add bias
  tripdat <- .x %>%
    obsSelect(pcov = covrate) %>%
    AddBias(metric = c("sp_1"), amount = biasrate) 
  
  #pass generated data through observer effect tests
  cbind(
    PopulationID = .x$PopulationID[1],
    target_bp = .x$target_bp[1],
    ObserverEffectStats(tripdat, metrics = c("sp_1","sp_2","biomass_total"), nperm_mvglm = nperm, nboot_triplet = nboot)
    )
  
}) %>%
  list_rbind(names_to = "rep") %>%
  assign_sig() 


res_OEall_b30_gentrips_df

save(res_OEall_b30_gentrips_df, file="output_data/simdat2spp500rep100perm_OEtests_b30_20250827.Rdat")
```
note: GLMM will return "boundary (singular) fit" error if vessels are drawn from the same population (musd = 0) but results are still valid



```{r}
res_OEall_b30_gentrips_df %>%
  group_by(metric, target_bp) %>%
  summarize(across(ends_with("sig"), mean), .groups="drop")
```

```{r, fig.width=10, fig.height=8}
bootstrap_size = 200
n_bootstraps = 500

res_OEall_b30_gentrips_df %>%
  select(target_bp, metric, ends_with("sig")) %>%
  mutate(bin = as.factor(target_bp)) %>%
  split(~bin) %>%
  map(.x=., .f=~{slice_sample(.x, n=bootstrap_size*n_bootstraps, replace=TRUE) %>%
      mutate(boot = rep(1:n_bootstraps, each=bootstrap_size)) %>%
      group_by(metric, bin, boot) %>%
      summarize(across(ends_with("sig"), mean), 
                .groups="drop")
    }) %>%
  list_rbind() %>%
  pivot_longer(cols=ends_with("sig"), names_to = "test", values_to = "pct_sig") %>%
  group_by(metric, bin, test) %>%
      summarize(power=mean(pct_sig),
                cilo = quantile(pct_sig, 0.025),
                cihi = quantile(pct_sig, 0.975),
                n=n(),
                .groups="drop") %>%
  ggplot(aes(x=bin, y=power, ymin=cilo, ymax=cihi, group=1)) +
  geom_point() +
  geom_line() +
  geom_ribbon(alpha = 0.2) +
  facet_grid(test~metric) +
  labs(x="species biomass as proprotion of total biomass",
       y="power (proportion of iterations with significant result)",
       title="Generated data using Tweedie model",
       subtitle = "5 iterations, 50% coverage, -50% observer effect, 100 permutations, 500 bootstraps, no vessel effect") +
  theme_bw() +
  coord_cartesian(ylim=c(0,1))

```














***what if the bias is different by vessel?
1 - have single bias rate for vessels with similar catches
2 - have single bias rate for vessels with different catches
3 - have variable bias rate for vessels with similar catches
4 - have variable bias rate for vessles with different catches (by vessel size?)

block = target (accounts for variables like duration, vessel size, distance offshore)


do vessel draws first and comprae how similar they are? or compare homogeneity within each simulated population

how confident can we be in the mvglm outputs
if my most abundant species is at least 50% of the catch, I can detect with 80% confidence a 20% observer effect 

real-life distribution has tweedie dist of 1.63


dominant species percent vs. minimum detectable effect size




hypothesis:
single species p-values should be similar to univariate tests for that species
multivariate p-value should be more powerful than summed-biomass univariate test at higher values of evenness (lower bp)